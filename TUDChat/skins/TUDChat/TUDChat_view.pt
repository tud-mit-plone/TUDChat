<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
  metal:use-macro="here/main_template/macros/master" i18n:domain="plone">
<head>

<metal:block metal:fill-slot="javascript_head_slot">

    <script language="javascript" src="jquery-1.7.min.js"></script>
    <script language="javascript" src="jquery.notification.js"></script>
    <script language="javascript" src="jquery.ba-dotimeout.min.js"></script>
    <script type="text/javascript" tal:content="string:var base_url = '${here/absolute_url}';"></script>
    <script language="javascript">
    $(document).ready(
        function() {
            $('#login').submit(function() {
              $("input[type='submit']").attr("disabled", "disabled");

              $.getJSON(base_url + "/registerMe", { user: $("input[name='username']").val(), chatroom: $("[name='chatroom']").val(), agreement: $("[name='agreement']").prop("checked"), password: $("#password").val() }, function(response) {

                $.doTimeout( 'enableSubmitButton', 2000, function(){
                    $("input[type='submit']").removeAttr("disabled");
                });

                if (response == true) {
                    window.location = base_url + "/chat?" + new Date().getTime();
                } else {
                    if (response.status.message != '')
                        $.notification.error(response.status.message);
                }
               });
              return false;
            });

            function updateVisibilityPasswordField() {
              if (jQuery.inArray(Number($('[name=chatroom]').val()), password_channels) != -1) {
                $(".password_field").show().children("#password").val("");
              } else {
                $(".password_field").hide().children("#password").val("");
              }
            }

            updateVisibilityPasswordField();
            $('[name=chatroom]').change(updateVisibilityPasswordField);


        }
    );
    </script>
</metal:block>

<metal:block metal:fill-slot="style_slot">
    <link rel="stylesheet" type="text/css" href="tud_chat.css" />
    <link rel="stylesheet" type="text/css" tal:attributes="href string:${here/absolute_url}/tud_chat_additional.css" />
</metal:block>

</head>

<body metal:fill-slot="main" i18n:domain="tudchat">

<tal:domain_check define="newurl python: here.checkURL(here.absolute_url());
                          dummy python: newurl and request.RESPONSE.redirect(newurl) or None">
</tal:domain_check>

<h2 tal:content="here/title"> Title of chat </h2>

<div class="chat_introduction" tal:content="here/introduction"> Introduction </div>

<div class="chat_explanation"><span class="introduction">Datenschutzhinweis:</span>
    Um an einem Chat teilnehmen zu können, wählen Sie bitte unten einen Chat-Raum aus, tragen Ihren gewünschten Benutzernamen ein und bestätigen, dass Sie diesen Datenschutzhinweis zur Kenntnis genommen haben. Um anonym zu bleiben, nutzen Sie bitte einen Nickname als Benutzernamen. Er muss zwischen 3 und 20 Zeichen lang sein und mindestens 3 Buchstaben enthalten. Wenn Sie eine Nachricht im Chat verschicken, können alle Teilnehmer den von Ihnen gewählten Benutzernamen und die Nachricht sehen. Die Nachrichten werden zusammen mit einem Zeitstempel über die Chatlaufzeit hinaus anonymisiert gespeichert. Bitte beachten Sie, dass persönliche Angaben in den Chatnachrichten nicht anonymisiert werden können. Die Moderatoren können die Chats im Nachhinein  ausschließlich  zur Verbesserung der FAQ-Angebote auswerten. Die Löschung der Daten erfolgt spätestens nach 3 Monaten. Die Räume sind zeitlich befristet und werden moderiert. Bei Fehlverhalten von Chatnutzern können Konsequenzen in Form von einer Verwarnung und permanenter Verweisung des Chatraums folgen. Zur Realisierung der Verweisung wird in diesem Fall ein Cookie in Ihrem Browser gesetzt. Private Nachrichten können aktuell im Chat nicht verschickt werden. Sollten Sie vertrauliche Informationen übertragen wollen, nutzen Sie bitte die E-Mail-Kontaktdaten auf den Webseiten.
</div>

<tal:block define="sessions python:here.getActiveChatSessions();
                   next_sessions python:here.getNextChatSessions()"
           condition="python:here.getActiveChatSessions() is not None">

    <form id="login" class="chat_login" action="" tal:condition="sessions">
        <script language="javascript" tal:content="python: 'var password_channels = [' + ','.join([str(session['id']) for session in sessions if session.get('password') != None]) + '];'"></script>
        <div>
          <label for="chatroom">Raum</label>
          <tal:block condition="python: len(sessions) > 1">
            <select name="chatroom">
                <tal:block repeat="session sessions">
                    <option tal:attributes="value session/id" class="chat_option" tal:content="session/name"> Chat session name </option>
                </tal:block>
            </select>
          </tal:block>
          <tal:block condition="python: len(sessions) == 1" tal:define="session python:sessions[0]">
            <input type="hidden" name="chatroom" tal:attributes="value session/id" /> <span class="chat_option" tal:content="session/name" />
          </tal:block>
        </div>

        <div>
          <label for="username">gewünschter Benutzername</label>
          <input type="text" name="username" id="username" maxlength="20" />
        </div>

        <div class="password_field">
          <label for="password">Passwort für den Chatraum</label>
          <input type="password" name="password" id="password" autocomplete="off" />
        </div>
        
        <div class="agreement_field">
		  <div class="left">
            <label for="agreement">Ich habe den Datenschutzhinweis gelesen und verstanden und möchte unter den darin genannten Bedingungen teilnehmen.</label>
          </div>
          <div class="left">
            <input type="checkbox" name="agreement" id="agreement" />
          </div>
          <div class="clear"></div>
        </div>

        <div>
          <label for="submit">&nbsp;</label>
          <input type="submit" name="submit" value="Anmelden"/>
        </div>
    </form>

    <tal:block condition="python: not sessions">
      <div class="chat_nosession">
        Es existiert derzeit keine aktive Chatsitzung.
        <span tal:condition="python: next_sessions">Es werden allerdings welche stattfinden.</span>
        <span tal:condition="python: not next_sessions">Es befindet sich auch keine Chatsitzung in Planung.</span>
      </div>
    </tal:block>


    <tal:block condition="python: next_sessions">
        <h3>Folgende Chatsitzungen werden zukünftig stattfinden:</h3>
        <table class="future_sessions">
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Beginn</th>
                    <th>Ende</th>
                </tr>
            </thead>
            <tbody>
                <tr tal:repeat="session next_sessions">
                    <td tal:content="session/name"></td>
                    <td tal:content="python: session['start'].strftime('%d.%m.%y')+' '+session['start'].strftime('%H:%M')+' Uhr'"></td>
                    <td tal:content="python: session['end'].strftime('%d.%m.%y')+' '+session['end'].strftime('%H:%M')+' Uhr'"></td>
                </tr>
            </tbody>
        </table>
    </tal:block>
</tal:block>
<p tal:condition="python:here.getActiveChatSessions() is None">Es wurde noch keine Datenbank konfiguriert. Diese kann in den Chat-Einstellungen eingestellt werden.</p>
</body>
</html>
