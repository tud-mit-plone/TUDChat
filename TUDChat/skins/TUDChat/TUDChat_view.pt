<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
  metal:use-macro="here/main_template/macros/master" i18n:domain="plone">
<head>

<metal:block metal:fill-slot="javascript_head_slot">

    <script language="javascript" src="jquery-1.7.min.js"></script>
    <script language="javascript" src="jquery.notification.js"></script>
    <script language="javascript" src="jquery.ba-dotimeout.min.js"></script>
    <script type="text/javascript" tal:content="string:var base_url = '${here/absolute_url}';"></script>
    <script language="javascript">
    $(document).ready(
        function() {
            $('#login').submit(function() {
              $("input[type='submit']").attr("disabled", "disabled");

              if (jQuery.inArray(Number($('[name=chatroom]').val()), password_channels) == -1) {
                  $.getJSON(base_url + "/registerMe", { user: $("input[name='username']").val(), chatroom: $("[name='chatroom']").val() }, function(response) {

                    $.doTimeout( 'enableSubmitButton', 2000, function(){
                        $("input[type='submit']").removeAttr("disabled");
                    });

                    if (response == true) {
                        window.location = base_url + "/chat?" + new Date().getTime();
                    } else {
                        if (response.status.message != '')
                            $.notification.error(response.status.message);
                    }
                   });
              } else {
                  $.notification.warn("Diese Chat-Session ist durch ein Passwort geschützt. <br/> <br/><form id='passwordForm'><label for='password'>Passwort:<"+"/label> <input type='password' id='password'/><"+"/form>", false,
                  [{"name" :"Ok",
                     "click": function() {
                       $.getJSON(base_url + "/registerMe", { user: $("input[name='username']").val(), chatroom: $("[name='chatroom']").val(), password: $("#password").val() }, function(response) {

                           if (response == true) {
                               window.location = base_url + "/chat?" + new Date().getTime();
                           } else {
                               if (response.status.message != '')
                                   $.notification.error(response.status.message);
                                   $("input[type='submit']").removeAttr("disabled");
                           }
                       });
                     }},
                  {"name" :"Abbrechen", "click": function() {
                    $.notification.clear();
                    $("input[type='submit']").removeAttr("disabled");
                    }
                  },
                  ]);

              }
              return false;
            });
        }
    );
    </script>
</metal:block>

<metal:block metal:fill-slot="css_slot">
    <link rel="stylesheet" type="text/css" href="tud_chat.css" />
    <link rel="stylesheet" type="text/css" tal:attributes="href string:${here/absolute_url}/tud_chat_additional.css" />
</metal:block>

</head>

<body metal:fill-slot="main" i18n:domain="tudchat">

<h2 tal:content="here/title"> Title of chat </h2>

<div class="chat_introduction" tal:content="here/introduction"> Introduction </div>

<tal:block define="sessions python:here.getActiveChatSessions();
                   next_sessions python:here.getNextChatSessions()"
           condition="python:here.getActiveChatSessions() is not None">


    <form id="login" class="chat_login" action="" tal:condition="sessions">
        <script language="javascript" tal:content="python: 'var password_channels = [' + ','.join([str(session['id']) for session in sessions if session.get('password') != None]) + '];'"></script>
        <div class="chat_explanation"><span class="introduction">Hinweis zur Benutzung:</span>Bitte wählen Sie einen Raum und einen Benutzernamen aus. Bitte beachten Sie, dass ein Raum zeitlich geöffnet ist und der Benutzername den formalen Ansprüchen genügen muss (3 bis 20 Zeichen, davon mindestens ein Buchstabe). Die Chaträume werden <em>moderiert</em> und es können bei Fehlverhalten Konsequenzen in Form von einer Verwarnung und permanenter Verweisung des Chatraums folgen.</div>

        <div>
          <label for="chatroom">Raum</label>
          <tal:block condition="python: len(sessions) > 1">
            <select name="chatroom">
                <tal:block repeat="session sessions">
                    <option tal:attributes="value session/id" class="chat_option" tal:content="session/name"> Chat session name </option>
                </tal:block>
            </select>
          </tal:block>
          <tal:block condition="python: len(sessions) == 1" tal:define="session python:sessions[0]">
            <input type="hidden" name="chatroom" tal:attributes="value session/id" /> <span class="chat_option" tal:content="session/name" />
          </tal:block>
        </div>

        <div>
          <label for="username">Benutzername</label>
          <input type="text" name="username" id="username" maxlength="20" />
        </div>

        <div>
          <label for="submit">&nbsp;</label>
          <input type="submit" name="submit" value="Anmelden"/>
        </div>
    </form>

    <tal:block condition="python: not sessions">
      <div class="chat_nosession">
        Leider existiert derzeit keine aktive Chatsitzung.
        <span tal:condition="python: next_sessions">Es werden allerdings welche stattfinden.</span>
        <span tal:condition="python: not next_sessions">Es befindet sich auch keine Chatsitzung in Planung.</span>
      </div>
    </tal:block>


    <tal:block condition="python: next_sessions">
        <h3>Folgende Chatsitzungen werden zukünftig stattfinden:</h3>
        <table class="future_sessions">
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Beginn</th>
                </tr>
            </thead>
            <tbody>
                <tr tal:repeat="session next_sessions">
                    <td tal:content="session/name"></td>
                    <td tal:content="python: session['start'].strftime('%d.%m.%y')+' '+session['start'].strftime('%H:%M')+' Uhr'"></td>
                </tr>
            </tbody>
        </table>
    </tal:block>
</tal:block>
<p tal:condition="python:here.getActiveChatSessions() is None">Es wurde noch keine Datenbank konfiguriert. Diese kann in den Chat-Einstellungen eingestellt werden.</p>
</body>
</html>
