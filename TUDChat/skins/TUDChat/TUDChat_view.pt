<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
  metal:use-macro="here/main_template/macros/master" i18n:domain="plone">
<head>

<metal:block metal:fill-slot="javascript_head_slot">

    <script language="javascript" src="jquery-1.7.min.js"></script>
    <script language="javascript" src="jquery.notification.js"></script>
    <script language="javascript" src="jquery.ba-dotimeout.min.js"></script>
    <script type="text/javascript" tal:content="string:var base_url = '${here/absolute_url}';"></script>
    <script language="javascript">
    $(document).ready(
        function(){
            $('#login').submit(function() {
              $("input[type='submit']").attr("disabled", "disabled");

              if (jQuery.inArray(Number($('[name=chatroom]').val()), password_channels) == -1){
                  $.getJSON(base_url + "/registerMe", { user: $("input[name='username']").val(), chatroom: $("select[name='chatroom']").val() }, function(response) {

                    $.doTimeout( 'enableSubmitButton', 2000, function(){
                        $("input[type='submit']").removeAttr("disabled");
                    });

                    if (response == true) {
                        window.location = base_url + "/chat?" + new Date().getTime();
                    } else {
                        if (response.status.message != '')
                            $.notification.error(response.status.message);
                    }
                   });
              }else{
                  $.notification.general("Diese Chat-Session ist durch ein Passwort geschützt. <br/> <br/><label for='password'>Passwort:<"+"/label> <input type='password' id='password'/>", false,
                                                                        [{"name" :"Ok",
                                                                            "click":function(){
                                                                              $.getJSON(base_url + "/registerMe", { user: $("input[name='username']").val(), chatroom: $("select[name='chatroom']").val(), password: $("#password").val() }, function(response) {
                                                                                  if (response == true) {
                                                                                      window.location = base_url + "/chat?" + new Date().getTime();
                                                                                  } else {
                                                                                      if (response.status.message != '')
                                                                                          $.notification.error(response.status.message);
                                                                                  }
                                                                              });
                                                                            }},
                                                                        {"name" :"Abbrechen", "click": $.notification.clear },
                                                                         ]);
              }

              return false;
            });
            $.get(base_url + "/status", '', function(data) {
                $('#status').val(data);
            });
            $('#logout').click(function(e) {
                e.preventDefault();
                $.get(base_url + '/logout', '', function(data) {
                   $.get(base_url + "/status", '', function(data) {
                    $('#status').val(data);
                   });
                });
            });
            $('#updateStatus').click(function() {
                $.get(base_url + "/status", '', function(data) {
                    $('#status').val(data);
                });
            });
        }
    );
    </script>
</metal:block>

<metal:block metal:fill-slot="css_slot">
    <link rel="stylesheet" type="text/css" href="tud_chat.css" />
    <link rel="stylesheet" type="text/css" tal:attributes="href string:${here/absolute_url}/tud_chat_additional.css" />
</metal:block>

</head>

<body metal:fill-slot="main" i18n:domain="tudchat">

<h2>Willkommen zum Chat!</h2>

<tal:block define="sessions python:here.getActiveChatSessions();
                   next_sessions python:here.getNextChatSessions()"
           condition="python:here.getActiveChatSessions() is not None">
    <form id="login" action="" tal:condition="python: len(sessions)>0">
        <script language="javascript" tal:content="python: 'var password_channels = ['+','.join([str(session['id']) for session in sessions if session.get('password') != None])+'];'"></script>
        <label for="">Raum</label>
        <select name="chatroom">
            <tal:block repeat="session sessions">
                <option tal:attributes="value session/id" tal:content="session/name">Sins-Chat</option>
            </tal:block>
        </select>
        <input type="text" name="username" maxlength="20"/>
        <input type="submit" value="Anmelden" />
        <button id='logout' tal:condition="python:here.isAdmin(here.REQUEST) == True">Logout (DEBUG)</button>
    </form>
    <p tal:condition="python: len(sessions)==0">Leider existiert zurzeit keine aktive Chat-Session.</p>
    <p tal:condition="python: len(sessions)==0 and len(next_sessions)==0">Es befindet sich auch keine Chat-Session in Planung.</p>
    <tal:block condition="python: len(next_sessions)>0">
        <br />
        Folgende Chat-Sessions finden zukünftig statt:
        <table>
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Startzeit</th>
                </tr>
            </thead>
            <tbody>
                <tr tal:repeat="session next_sessions">
                    <td tal:content="session/name"></td>
                    <td tal:content="python: session['start'].strftime('%d.%m.%y')+' '+session['start'].strftime('%H:%M')+' Uhr'"></td>
                </tr>
            </tbody>
        </table>
    </tal:block>
</tal:block>
<p tal:condition="python:here.getActiveChatSessions() is None">Es wurde noch keine Datenbank konfiguriert. Diese kann in den Chat-Einstellungen eingestellt werden.</p>

<tal:block condition="python:here.isAdmin(here.REQUEST) == True">
  <br />
  <div><a href="chat">Chat direkt betreten</a> (falls bereits angemeldet)</div>
  <p>Status: (DEBUG)</p>
  <textarea style="width:900px;height:100px;" id='status'></textarea>
  <br/>
  <button id='updateStatus'>Update status (DEBUG)</button>
</tal:block>
</body>
</html>
